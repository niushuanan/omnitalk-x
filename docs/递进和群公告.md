# OmniTalk X 产品需求文档 (PRD)
## 功能一：群公告 | 功能二：递进式互动

---

**文档版本**: v1.1  
**更新日期**: 2026-02-17  
**产品经理**: -  
**技术负责人**: -

---

## 1. 概述

### 1.1 背景

OmniTalk X 是一个多AI群聊应用，用户可以在群聊中同时与多个AI进行互动。本次迭代计划新增两个功能：

| 功能 | 描述 |
|------|------|
| 群公告 | 为每个群聊添加专属公告，注入AI的System Prompt |
| 递进式互动 | AI按顺序依次回复，后续AI可以看到前置AI的回复内容 |

### 1.2 核心决策（基于问答确认）

| 功能 | 核心决策 |
|------|----------|
| 模式 | 只保留递进模式，不需要并行/智能模式切换，默认即为递进 |
| 递进触发 | @指定AI或随机AI，按现有机制 |
| AI顺序 | 每次发送消息时随机打乱顺序 |
| 前置发言 | 只包含当前轮次的前置回复，不包含历史轮次 |
| 公告生效 | 群聊中使用，私聊不使用 |
| 数据迁移 | 旧群组自动生成默认公告模板 |

---

## 2. 功能一：群公告

### 2.1 功能概述

群公告是每个群组的专属说明文本，会被注入到AI的System Prompt中，影响AI的回复行为。

**典型使用场景**：
- 用户创建"技术讨论组"，设置公告"你是技术专家群，只讨论技术话题"
- 用户创建"闲聊群"，设置公告"这是一个轻松愉快的聊天群"

### 2.2 需求详情

#### 2.2.1 公告编辑

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| GA-001 | 用户可以在群组设置中编辑群公告文本 | 编辑入口在群组编辑弹窗 |
| GA-002 | 公告文本支持多行输入，最大2000字符 | - |
| GA-003 | 公告为空时，使用默认模板生成公告 | - |
| GA-004 | 全员群不支持自定义公告，只使用默认模板 | 全员群定义：名称为"全员群"且包含所有AI成员 |
| GA-005 | 公告编辑后需要点击保存按钮生效 | - |
| GA-006 | 保存公告后立即生效，下一条消息就开始使用新公告 | 无需刷新页面 |

#### 2.2.2 公告存储

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| GA-007 | 群公告存储在backend的groups.json中，字段名为`announcement` | 兼容现有数据结构 |
| GA-008 | 新增API `PUT /api/groups/{group_id}/announcement` 用于更新公告 | - |
| GA-009 | 新增API `GET /api/groups/{group_id}/announcement` 用于获取公告 | - |
| GA-010 | 群组列表API `/api/groups` 返回值中包含`announcement`字段 | - |

#### 2.2.3 默认公告模板

当用户未设置公告时，使用以下默认模板：

```
这是一个名为「{群名}」的群聊，群成员有{成员名1}、{成员名2}、{成员名3}等等（包含小庄）。
```

**全员群（grp_all）的默认公告**：
```
这是一个名为「全员群」的群聊，群成员有ChatGPT、Claude、Gemini、GLM、Kimi、MiniMax、Qwen、DeepSeek、Seed等等（包含小庄）。
```

**示例**：
- 群组名称：技术讨论组
- AI成员：ChatGPT、Claude、Gemini
- 生成的公告：`这是一个名为「技术讨论组」的群聊，群成员有ChatGPT、Claude、Gemini等等（包含小庄）。`

#### 2.2.4 System Prompt构成

System Prompt 由以下三部分按顺序构成：

```
第1部分：用户自定义的 System Prompt
- 来源：用户在设置页面为每个AI配置的个性化提示词
- 存储：localStorage key `system_prompt_{model}`
- 说明：这是AI的"人设"，定义AI的角色性格

第2部分：群组公告 Prompt
- 来源：用户在群组设置中编辑的群公告
- 存储：groups.json 的 announcement 字段
- 说明：只在群聊中生效，定义当前群聊的用途
- 私聊模式不使用

第3部分：前置 AI 发言（仅递进模式）
- 来源：当前轮次中前面AI的回复
- 说明：只有第一个回复的AI没有这部分内容
```

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| GA-011 | System Prompt构建顺序：用户自定义 → 群公告 → 前置发言 | - |
| GA-012 | 群公告在该群内会一直生效，加在每个喂给AI的prompt之中 | - |
| GA-013 | 私聊模式不使用群公告 | - |

#### 2.2.5 前端localStorage存储

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| GA-014 | 现有localStorage key格式：`system_prompt_{model}` | 用户自定义的AI人设提示词 |
| GA-015 | 新增localStorage key格式：`system_prompt_{model}_grp_{groupId}` | 用户为特定群组设置的额外提示词 |
| GA-016 | 获取Prompt时的查找顺序：群组自定义 → 全局自定义 → 后端默认 | 从高到低优先级 |
| GA-017 | 删除群组时，清理localStorage中该群组的自定义Prompt | - |

### 2.3 UI/UX设计

#### 2.3.1 群组编辑弹窗

在现有的群组编辑弹窗中增加"群公告"区块：

```
┌─────────────────────────────────────┐
│  编辑群组                    ×      │
├─────────────────────────────────────┤
│  群组名称                           │
│  [________________]                  │
│                                     │
│  选择 AI 成员 (3)                   │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐      │
│  │ ✓  │ │    │ │ ✓  │ │    │      │
│  └────┘ └────┘ └────┘ └────┘      │
│                                     │
│  群公告                             │
│  ┌────────────────────────────────┐ │
│  │ 这是一个名为「技术讨论组」的.. │ │
│  │                                │ │
│  └────────────────────────────────┘ │
│  * 不填则使用默认公告               │
│                                     │
│           [删除群组]    [取消] [保存]│
└─────────────────────────────────────┘
```

#### 2.3.2 交互说明

| 场景 | 行为 |
|------|------|
| 原来没有公告 | 编辑框显示默认模板内容，供用户参考/修改 |
| 用户清空公告 | 保存后使用默认公告模板 |
| 保存公告后 | 立即生效，无需刷新页面 |

### 2.4 API设计

#### 2.4.1 获取群组列表（含公告）

```
GET /api/groups
```

**响应**：
```json
{
  "success": true,
  "groups": [
    {
      "id": "grp_all",
      "name": "全员群",
      "bots": ["chatgpt", "claude", ...],
      "bot_names": ["ChatGPT", "Claude", ...],
      "bot_count": 10,
      "is_default": true,
      "created_at": "2024-01-01T00:00:00",
      "announcement": ""  // 全员群使用默认模板
    },
    {
      "id": "grp_123456",
      "name": "技术讨论组",
      "bots": ["chatgpt", "claude", "grok"],
      "bot_names": ["ChatGPT", "Claude", "Grok"],
      "bot_count": 3,
      "is_default": false,
      "created_at": "2024-01-15T00:00:00",
      "announcement": "你是技术专家群，只讨论技术话题"
    }
  ]
}
```

#### 2.4.2 获取指定群公告

```
GET /api/groups/{group_id}/announcement
```

**响应**：
```json
{
  "success": true,
  "announcement": "你是技术专家群，只讨论技术话题",
  "is_default": false
}
```

**错误响应（群组不存在）**：
```json
{
  "success": false,
  "message": "群组不存在"
}
```

#### 2.4.3 更新群公告

```
PUT /api/groups/{group_id}/announcement
```

**请求体**：
```json
{
  "announcement": "你是技术专家群，只讨论技术话题"
}
```

**响应**：
```json
{
  "success": true,
  "group": {
    "id": "grp_123456",
    "name": "技术讨论组",
    "bots": ["chatgpt", "claude", "grok"],
    "announcement": "你是技术专家群，只讨论技术话题",
    ...
  }
}
```

**错误响应（全员群不可编辑）**：
```json
{
  "success": false,
  "message": "全员群不支持自定义公告"
}
```

### 2.5 边界情况与兼容性

| 场景 | 处理方式 |
|------|----------|
| 旧版本groups.json无announcement字段 | 加载时补空字符串，使用默认模板生成 |
| 切换群组时 | 切换后重新构建System Prompt |
| 删除群组时 | 同时清理对应的localStorage |
| 全员群编辑公告 | 禁止，返回错误提示（判断条件：名称为"全员群"且包含所有AI成员） |
| 群组AI成员变更 | 保留用户已编辑的公告，不自动更新 |
| 用户清空公告 | 保存后使用默认公告模板 |
| 升级新版本 | 旧群组自动生成默认公告模板 |
| 私聊模式 | 不使用群公告 |
| 每次发送消息 | 从groups.json读取最新公告，不使用缓存 |

---

## 3. 功能二：递进式互动

### 3.1 功能概述

递进式互动是多AI群聊的核心模式：用户发送消息后，多个AI按随机顺序依次回复，后续AI可以看到前置AI的回复内容。

**核心特点**：
- 只保留递进模式，不需要并行/智能模式切换
- AI顺序每次都随机打乱
- 后续AI能看到前置AI的回复
- 递进互动永远是最基础的功能

### 3.2 需求详情

#### 3.2.1 触发方式

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| PI-001 | 用户@指定AI时，被@的AI参与递进 | - |
| PI-002 | 用户@所有人时，群组所有AI参与递进 | - |
| PI-003 | 用户没有@人时，随机选择AI参与递进 | 按现有随机机制 |

#### 3.2.2 响应顺序

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| PI-004 | AI响应顺序每次都随机打乱 | 每次发送消息时重新随机 |
| PI-005 | 互动强度默认"中量"（最近4条前置发言） | - |
| PI-006 | 互动强度可选：轻量（2条）/ 中量（4条）/ 全部 | - |

#### 3.2.3 前置发言

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| PI-007 | 每个AI回复时，其System Prompt中包含【前置发言】区块 | - |
| PI-008 | 前置发言只包含当前轮次的前置AI回复 | 不包含历史轮次 |
| PI-009 | 如果前置发言内容过长，接近API的Token限制，优先保留最近的 | 截断处理 |

**System Prompt格式（递进模式）**：

```
第1部分：用户自定义的 System Prompt
- 来源：用户在设置页面配置的提示词

第2部分：群组公告 Prompt
- 来源：群组的公告内容

第3部分：前置 AI 发言（仅非第一个AI有）
- 格式：
ChatGPT说：xxx
Claude说：yyy
- 说明：只有第一个回复的AI没有这部分
```

#### 3.2.4 执行流程

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| PI-010 | 串行执行：AI1响应完成后才开始AI2 | - |
| PI-011 | 使用SSE流式输出 | 与现有单AI聊天一致 |
| PI-012 | 上下文添加时机：等AI回复完成（finished=true）后才添加到上下文 | - |
| PI-013 | 页面刷新后保留模式设置 | 递进是默认模式 |

#### 3.2.5 错误处理

| 场景 | 处理方式 |
|------|----------|
| 某个AI响应超时 | 跳过该AI，继续下一个AI |
| 某个AI返回空响应 | 跳过该AI，继续下一个AI |
| 某个AI API错误 | 跳过该AI，继续下一个AI |
| 网络错误（连接超时） | 终止整个递进流程 |
| API Key无效或过期 | 立即终止整个递进流程 |
| 递进失败 | 弹窗提醒用户 |

#### 3.2.6 用户交互

| 需求ID | 需求描述 | 备注 |
|--------|----------|------|
| PI-014 | 用户发送消息后，必须等AI回复完才能再发下一条 | 现有机制保持不变 |
| PI-015 | 递进过程中不支持用户取消 | - |
| PI-016 | 递进失败时用户无法点击重试 | 弹窗提醒后结束 |

### 3.3 API设计

#### 3.3.1 递进式对话API

**实现方式**：在现有API上增加参数，区分并行/递进模式

**复用的现有API**：
- `POST /api/chat/group` - 群聊（随机AI回复）
- `POST /api/chat/mention` - @指定AI回复

**新增请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| mode | string | 否 | 模式：`parallel`（并行，默认）或 `progressive`（递进） |
| intensity | string | 否 | 递进模式下的互动强度：light/medium/full，默认medium |

**示例请求**：
```json
{
  "message": "你好",
  "group_id": "grp_123456",
  "mode": "progressive",
  "intensity": "medium",
  "mention_all": false,
  "mentioned": ["chatgpt", "claude"]
}
```

**响应**：SSE流式响应

**SSE响应格式说明（方案A：分隔标记）**：
- 每个AI的响应通过SSE流式输出
- 不同AI的响应之间通过分隔标记 `{"separator": true, "next_provider": "xxx"}` 分隔
- 前端解析分隔标记后知道"现在轮到下一个AI了"
- 分隔标记不在UI上展示，只用于代码逻辑区分

```sse
data: {"provider": "chatgpt", "content": "你", "finished": false}
data: {"provider": "chatgpt", "content": "你好", "finished": false}
data: {"provider": "chatgpt", "content": "你好！", "finished": true}
data: {"separator": true, "next_provider": "claude"}
data: {"provider": "claude", "content": "你", "finished": false}
data: {"provider": "claude", "content": "你好呀", "finished": true}
data: [DONE]
```

| 字段 | 说明 |
|------|------|
| provider | 当前正在回复的AI标识 |
| content | AI回复的内容（逐字输出） |
| finished | 是否完成，true表示该AI已说完 |
| separator | 分隔标记，true表示"这个AI说完了，下一个AI准备" |
| next_provider | 下一个AI的标识 |
POST /api/chat/progressive
```

**请求头**：
```
Content-Type: application/json
X-Api-Key: (可选)sk-or-v1-xxx
```

**请求体**：
```json
{
  "message": "你好",
  "group_id": "grp_123456",
  "intensity": "medium",
  "mention_all": false,
  "mentioned": ["chatgpt", "claude"]
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| message | string | 是 | 用户发送的消息 |
| group_id | string | 是 | 群组ID |
| intensity | string | 否 | 互动强度：light/medium/full，默认medium |
| mention_all | boolean | 否 | 是否@所有人，默认false |
| mentioned | array | 否 | 被@的AI列表，默认空数组 |

**响应**：SSE流式响应

**响应格式说明**：
- 每个AI的响应通过SSE流式输出
- 不同AI的响应之间通过特殊的JSON标记分隔
- 前端通过解析JSON中的字段来区分不同AI的响应

```sse
data: {"provider": "chatgpt", "content": "你好！", "finished": false}
data: {"provider": "chatgpt", "content": "有什么", "finished": false}
data: {"provider": "chatgpt", "content": "我可以帮你什么？", "finished": true}
data: {"separator": true, "next_provider": "claude"}
data: {"provider": "claude", "content": "你好呀", "finished": false}
...
data: [DONE]
```

**完整响应示例**：
```json
{
  "success": true,
  "results": [
    {
      "provider": "chatgpt",
      "content": "你好！有什么我可以帮你的？",
      "success": true
    },
    {
      "provider": "claude",
      "content": "嗨！我是Claude，很高兴见到你！",
      "success": true
    },
    {
      "provider": "grok",
      "content": "有什么问题尽管问",
      "success": true
    }
  ]
}
```

#### 3.3.2 错误响应

**请求参数错误**：
```json
{
  "success": false,
  "msg": "消息不能为空"
}
```

**群组不存在**：
```json
{
  "success": false,
  "msg": "群组不存在"
}
```

**部分AI失败（跳过继续）**：
```json
{
  "success": true,
  "results": [
    {
      "provider": "chatgpt",
      "content": "你好！",
      "success": true
    },
    {
      "provider": "claude",
      "content": "",
      "success": false,
      "error": "API请求失败"
    }
  ]
}
```

**网络错误（终止流程）**：
```json
{
  "success": false,
  "msg": "网络连接失败，请检查网络后重试"
}
```

### 3.4 边界情况与兼容性

| 场景 | 处理方式 |
|------|----------|
| 群组只有1个AI | 退化为单AI回复 |
| 2个AI都失败 | 弹窗提醒，结束流程 |
| 用户快速连续发送多条消息 | 现有机制：必须等AI回复完才能再发 |
| 页面刷新 | 保留递进模式设置 |
| Token超限 | 截断前置发言，保留最近的内容 |
| 群组ID不存在 | 返回错误，提示"群组不存在" |
| 群组没有配置任何AI | 返回错误，提示"该群组没有AI成员" |
| 消息内容为空或只有空格 | 返回错误，提示"消息不能为空" |

---

## 4. 技术方案

### 4.1 后端修改

#### 4.1.1 group_service.py

**新增功能**：
1. `get_group_announcement(group_id)` - 获取群公告
2. `update_group_announcement(group_id, announcement)` - 更新群公告
3. `generate_default_announcement(group)` - 生成默认公告模板
4. `get_group_announcement_for_prompt(group_id)` - 获取用于Prompt的公告内容

**字段变更**：
- create_group: 新增announcement字段默认为空
- load_groups: 兼容旧数据，无announcement字段时返回空

#### 4.1.2 route_groups.py

**新增API**：
```python
@router.get("/groups/{group_id}/announcement")
async def get_announcement(group_id: str):
    """获取群公告"""

@router.put("/groups/{group_id}/announcement")
async def update_announcement(group_id: str, request: UpdateAnnouncementRequest):
    """更新群公告"""
```

**API响应变更**：
- GET /groups: 返回值增加announcement字段

#### 4.1.3 service_openrouter.py

**修改build_payload函数**：
1. 新增参数：group_id, previous_responses, intensity
2. System Prompt构建逻辑：
   - Base Prompt
   - 群公告（如果存在）
   - 前置发言（如果存在递进模式）
   - 自定义Prompt

**新增函数**：
```python
def build_progressive_system_prompt(
    provider: str,
    group_id: str = None,
    previous_responses: list = None,
    intensity: str = "medium"
) -> str:
    """构建递进模式的System Prompt"""
```

#### 4.1.4 route_openrouter.py

**修改方案**：在现有API上增加mode参数，区分并行/递进模式

**修改的现有API**：
- `POST /api/chat/group` - 群聊API
- `POST /api/chat/mention` - @提及API

**新增参数**：
- `mode`: `parallel`（并行，默认）或 `progressive`（递进）
- `intensity`: `light`/`medium`/`full`，仅当mode为progressive时生效

**核心逻辑**：
1. 解析请求参数，获取mode和intensity
2. 如果mode为`progressive`：
   - 随机打乱AI顺序
   - 串行调用AI，每次收集前置发言
   - SSE输出时添加分隔标记
3. 如果mode为`parallel`（默认）：
   - 保持现有并行逻辑不变

### 4.2 前端修改

#### 4.2.1 store/group.ts

**接口变更**：
```typescript
export interface GroupInfo {
    id: string;
    name: string;
    bots: string[];
    bot_names: string[];
    bot_count: number;
    is_default: boolean;
    created_at: string;
    announcement?: string;  // 新增字段
}
```

#### 4.2.2 store/config.ts

**状态变更**：
- 移除非递进相关模式（并行/智能）
- 只保留递进模式作为默认

#### 4.2.3 constants/models.ts

**常量变更**：
- 移除 PARALLEL_MODE, SMART_MODE
- 只保留默认的递进模式

#### 4.2.4 services/fetch.ts

**getSystemPromptByModel函数增强**：
```typescript
const getSystemPromptByModel = (model: string, groupId?: string): string => {
    // 1. 先查找群组特定的自定义Prompt
    if (groupId) {
        const groupPrompt = localStorage.getItem(`system_prompt_${model}_grp_${groupId}`);
        if (groupPrompt && groupPrompt.trim()) {
            return groupPrompt;
        }
    }
    
    // 2. 查找全局自定义Prompt
    const customPrompt = localStorage.getItem('system_prompt_' + model);
    if (customPrompt && customPrompt.trim()) {
        return customPrompt;
    }
    
    // 3. 使用后端默认 prompt
    if (defaultPromptsCache[model]) {
        return defaultPromptsCache[model];
    }
    
    return '';
};
```

#### 4.2.5 pages/chat/components/group-list/group-list.tsx

**UI变更**：
1. 群组编辑弹窗中增加"群公告"输入区域
2. 如果用户未编辑公告，编辑框显示默认模板供用户参考
3. 保存后刷新群组列表

### 4.3 数据流

#### 4.3.1 群公告数据流

```
用户编辑公告
    ↓
PUT /api/groups/{id}/announcement
    ↓
group_service.update_group_announcement()
    ↓
保存到 groups.json
    ↓
用户发送消息
    ↓
从 groups.json 读取最新公告（不使用缓存）
    ↓
构建 System Prompt（第1部分自定义 + 第2部分公告）
    ↓
调用 AI
```

#### 4.3.2 递进模式数据流

```
用户发送消息
    ↓
前端调用 POST /api/chat/group 或 /api/chat/mention
    ↓
请求参数中包含 mode="progressive" 和 intensity="medium"
    ↓
后端随机打乱AI顺序
    ↓
遍历AI列表：
    for AI in AIs:
        构建带前置发言的System Prompt（第1部分+第2部分+第3部分）
        调用AI获取响应
        SSE输出响应内容
        等待finished=true后，收集响应到previous_responses
        输出分隔标记 {"separator": true, "next_provider": "xxx"}
    ↓
前端解析SSE流（识别分隔标记区分不同AI）
    ↓
逐个显示AI回复（和现有群聊展示方式一致）
    ↓
等AI回复完成后（finished=true）添加到上下文
```

---

## 5. 文件修改清单

### 5.1 后端文件

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| backend/service/group_service.py | 修改 | 增加announcement字段CRUD，新增生成默认公告函数 |
| backend/api/route_groups.py | 修改 | 新增公告相关API |
| backend/service/service_openrouter.py | 修改 | build_payload支持群公告和前置发言，增加mode参数判断 |
| backend/api/route_openrouter.py | 修改 | 现有API增加mode和intensity参数，递进模式走新逻辑 |
| groups.json | 修改 | 增加announcement字段 |

### 5.2 前端文件

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| frontend/src/store/group.ts | 修改 | GroupInfo接口增加announcement字段 |
| frontend/src/store/config.ts | 修改 | 简化为只保留递进模式 |
| frontend/src/constants/models.ts | 修改 | 移除并行/智能模式常量 |
| frontend/src/services/fetch.ts | 修改 | Prompt获取支持群组维度，mode参数传递 |
| frontend/src/pages/chat/components/group-list/group-list.tsx | 修改 | 群公告编辑UI |
| frontend/src/pages/chat/components/home/home.tsx | 修改 | 解析SSE分隔标记，区分不同AI的响应 |

---

## 6. 优先级与排期

### 6.1 优先级

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 群公告 - 基础功能 | P0 | 必须完成 |
| 群公告 - System Prompt注入 | P0 | 必须完成 |
| 递进式互动 - 基础功能 | P0 | 必须完成 |
| 群公告 - 群组特定自定义Prompt | P1 | 可选 |

### 6.2 排期建议

| 阶段 | 工作项 | 预估工时 |
|------|--------|----------|
| 1 | 后端：群公告字段与API | 1天 |
| 2 | 后端：Prompt构建逻辑 | 1天 |
| 3 | 后端：递进式对话API | 1天 |
| 4 | 前端：群公告UI | 1天 |
| 5 | 前端：递进模式对接 | 1天 |
| 6 | 测试与Bug修复 | 1天 |

**总预估**: 6天

---

## 7. 风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|----------|
| System Prompt过长导致API超限 | 中 | 设置Prompt最大长度限制，根据intensity截断前置发言 |
| 递进模式响应时间过长 | 中 | 限制并发AI数量，设置超时跳过 |
| 群组数据迁移兼容性 | 低 | 旧数据补空字段，自动生成默认模板 |
| 公告不同步 | 中 | 每次发消息从groups.json读取最新公告 |
| 浏览器缓存导致功能异常 | 低 | 代码层面处理 |
| SSE分隔标记解析错误 | 中 | 前端正确解析separator字段，确保UI正确区分不同AI |

---

## 8. 附录

### 8.1 术语表

| 术语 | 定义 |
|------|------|
| 用户自定义 System Prompt | 用户在设置页面为每个AI配置的个性化提示词，定义AI的角色性格 |
| 群公告 | 用户为群组设置的自定义公告文本，定义当前群聊的用途 |
| 前置发言 | 递进模式下，当前AI可以看到的前面AI的回复 |
| 互动强度 | 控制前置发言的数量：轻量(2条)/中量(4条)/全部 |
| 递进模式 | AI按顺序依次回复，后续AI能看到前置发言 |
| SSE | Server-Sent Events，服务端推送技术，用于流式输出 |
| 分隔标记 | SSE响应中用于区分不同AI的JSON标记 `{"separator": true, "next_provider": "xxx"}` |
| 全员群 | 名称为"全员群"且包含所有AI成员的群组，不可编辑公告 |

### 8.2 现有机制参考

| 功能 | 当前实现 |
|------|----------|
| 随机AI选择 | 从群组AI中随机选择3个 |
| @所有人 | 使用群组所有AI |
| @指定AI | 只使用被@的AI |
| 上下文管理 | 每个AI独立的上下文存储 |
| 流式输出 | SSE格式，逐字输出 |

### 8.3 API Key存储

- 后端：api_key.txt 文件
- 前端：localStorage key `omnitalk9_api_key`
- 请求头：`X-Api-Key`

---

**文档结束**
